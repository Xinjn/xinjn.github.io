"use strict";(self.webpackChunkwiki=self.webpackChunkwiki||[]).push([[47],{3905:(e,t,n)=>{n.d(t,{Zo:()=>l,kt:()=>d});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},c=Object.keys(e);for(r=0;r<c.length;r++)n=c[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(r=0;r<c.length;r++)n=c[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=r.createContext({}),u=function(e){var t=r.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},l=function(e){var t=u(e.components);return r.createElement(i.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},_=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,c=e.originalType,i=e.parentName,l=o(e,["components","mdxType","originalType","parentName"]),_=u(n),d=a,f=_["".concat(i,".").concat(d)]||_[d]||p[d]||c;return n?r.createElement(f,s(s({ref:t},l),{},{components:n})):r.createElement(f,s({ref:t},l))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var c=n.length,s=new Array(c);s[0]=_;var o={};for(var i in t)hasOwnProperty.call(t,i)&&(o[i]=t[i]);o.originalType=e,o.mdxType="string"==typeof e?e:a,s[1]=o;for(var u=2;u<c;u++)s[u]=n[u];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}_.displayName="MDXCreateElement"},11489:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>s,default:()=>p,frontMatter:()=>c,metadata:()=>o,toc:()=>u});var r=n(87462),a=(n(67294),n(3905));const c={},s=void 0,o={unversionedId:"\u6846\u67b6/\u524d\u53f0/\u5fae\u4fe1/\u5fae\u4fe1\u540e\u7aef\u63a5\u53e3",id:"\u6846\u67b6/\u524d\u53f0/\u5fae\u4fe1/\u5fae\u4fe1\u540e\u7aef\u63a5\u53e3",title:"\u5fae\u4fe1\u540e\u7aef\u63a5\u53e3",description:"\u524d\u7aef\u76f4\u63a5\u8c03\u7528\u63a5\u53e3\u5373\u53ef",source:"@site/docs/\u6846\u67b6/\u524d\u53f0/\u5fae\u4fe1/\u5fae\u4fe1\u540e\u7aef\u63a5\u53e3.md",sourceDirName:"\u6846\u67b6/\u524d\u53f0/\u5fae\u4fe1",slug:"/\u6846\u67b6/\u524d\u53f0/\u5fae\u4fe1/\u5fae\u4fe1\u540e\u7aef\u63a5\u53e3",permalink:"/docs/\u6846\u67b6/\u524d\u53f0/\u5fae\u4fe1/\u5fae\u4fe1\u540e\u7aef\u63a5\u53e3",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/\u6846\u67b6/\u524d\u53f0/\u5fae\u4fe1/\u5fae\u4fe1\u540e\u7aef\u63a5\u53e3.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\u5e95\u90e8\u5bfc\u822a\u680f",permalink:"/docs/\u6846\u67b6/\u524d\u53f0/\u5fae\u4fe1/\u5e95\u90e8\u5bfc\u822a\u680f"},next:{title:"\u7981\u6b62\u4e0b\u62c9",permalink:"/docs/\u6846\u67b6/\u524d\u53f0/\u5fae\u4fe1/\u7981\u6b62\u4e0b\u62c9"}},i={},u=[],l={toc:u};function p(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"\u524d\u7aef\u76f4\u63a5\u8c03\u7528\u63a5\u53e3\u5373\u53ef\n",(0,a.kt)("inlineCode",{parentName:"p"},"wechat.js")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"const util = require('util');\nconst crypto = require('crypto');\nconst request = require('../../common/request');\nconst config = require('../../configs');\nconst redis = require('../../common/redis')('default');\n\nconst jsapi_accesstoken_url = \"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=%s&secret=%s\";\nconst jsapi_ticke_url = \"https://api.weixin.qq.com/cgi-bin/ticket/getticket?type=jsapi&access_token=%s\";\n\nconst auth_url = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=%s&redirect_uri=%s&response_type=code&scope=snsapi_userinfo&state=%s#wechat_redirect';\nconst base_auth_url = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=%s&redirect_uri=%s&response_type=code&scope=snsapi_base&state=%s#wechat_redirect';\n\nconst auth_access_token_url = 'https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&secret=%s&code=%s&grant_type=authorization_code';\nconst auth_userinfo_url = 'https://api.weixin.qq.com/sns/userinfo?access_token=%s&openid=%s&lang=zh_CN';\n\nconst Cache_Key_Jsapi_Ticket = util.format(\"wx:%s:jsapi.ticket\", config.wechat.appid);\nconst Cache_Key_Jsapi_Access_Token = util.format(\"wx:%s:jsapi.accesstoken\", config.wechat.appid);\nconst uuidV4 = require('uuid');\nconst Cache_Expire_Time = 3600; //\u7f13\u5b581\u5c0f\u65f6\nconst redirect_uri = '/v2/wechat/callback';\n\n//SHA1\nfunction SHA1(str) {\n    let sha = crypto.createHash('sha1');\n    sha.update(str);\n    return sha.digest('hex');\n}\n\n/**\n * \u83b7\u53d6\u5fae\u4fe1\u8ba4\u8bc1URL\n * @returns {ServerResponse}\n */\nexports.auth_url = function (callbackUrl) {\n    let state = encodeURIComponent(callbackUrl);\n    let url = encodeURIComponent(config.default.base_url + redirect_uri);\n    return util.format(auth_url, config.wechat.appid, url, state);\n};\n\n/**\n * \u83b7\u53d6\u5fae\u4fe1\u8ba4\u8bc1URL\n * @returns {ServerResponse}\n */\nexports.wechat_auth_url = function (callback_url, redirect_url) {\n    let state = encodeURIComponent(redirect_url);\n    let url = '';\n    if(/^http/.test(callback_url)){\n        url = encodeURIComponent(callback_url);\n    }else{\n        url = encodeURIComponent(config.default.base_url + callback_url);\n    }\n\n    return util.format(auth_url, config.wechat.appid, url, state);\n};\n/**\n * \u83b7\u53d6\u5fae\u4fe1\u8ba4\u8bc1URL(\u9759\u9ed8)\n * @returns {ServerResponse}\n */\nexports.wechat_base_auth_url = function (callback_url, redirect_url) {\n    let state = encodeURIComponent(redirect_url);\n    let url = '';\n    if(/^http/.test(callback_url)){\n        url = encodeURIComponent(callback_url);\n    }else{\n        url = encodeURIComponent(config.default.base_url + callback_url);\n    }\n\n    return util.format(base_auth_url, config.wechat.appid, url, state);\n};\n/**\n * \u83b7\u53d6\u5fae\u4fe1access_token\n * @param access_token_url\n */\nexports.get_access_token = async (code) => {\n    let access_token_url = util.format(auth_access_token_url, config.wechat.appid, config.wechat.appsecret, code);\n    let body = await request.get({url: access_token_url});\n    return JSON.parse(body);\n};\n\n/**\n * \u83b7\u53d6\u7528\u6237\u4fe1\u606f\n * @param userinfo_url\n */\nexports.get_userinfo = async (access_token, openid) => {\n    let userinfo_url = util.format(auth_userinfo_url, access_token, openid);\n    let body = await request.get({url: userinfo_url});\n    return JSON.parse(body);\n};\n\n/**\n * \u83b7\u53d6JSAPI Access Token\n */\nasync function get_jsapi_access_token() {\n    let token = await redis.get(Cache_Key_Jsapi_Access_Token);\n    if (token && token.length > 0) {\n        // return token;\n    }\n    let url = util.format(jsapi_accesstoken_url, config.wechat.appid, config.wechat.appsecret);\n    let json = await  request.get({url: url});\n    json = JSON.parse(json);\n    token = json.access_token;\n    redis.set(Cache_Key_Jsapi_Access_Token, token, \"EX\", Cache_Expire_Time);\n    return token;\n}\nexports.get_jsapi_access_token = get_jsapi_access_token;\n\n/**\n * \u83b7\u53d6JSAPI Ticket\n */\nasync function get_jsapi_ticket() {\n    let ticket = await redis.get(Cache_Key_Jsapi_Ticket);\n    if (ticket && ticket.length.length > 0) {\n        return ticket;\n    }\n    let token = await get_jsapi_access_token();\n    console.log('token:',token)\n    let url = util.format(jsapi_ticke_url, token);\n    let json = await request.get({url: url});\n    json = JSON.parse(json);\n    ticket = json.ticket;\n    redis.set(Cache_Key_Jsapi_Ticket, ticket, \"EX\", Cache_Expire_Time);\n    return ticket;\n\n}\nexports.get_jsapi_ticket = get_jsapi_ticket;\n\n/**\n * \u83b7\u53d6\u5f53\u524durl\u7684\u7b7e\u540d\u4fe1\u606f\n */\nasync function get_jsapi_signature(url) {\n\n    let uuid = uuidV4(); // -> '110ec58a-a0f2-4ac4-8393-c866d813b8d1'\n    let ticket = await get_jsapi_ticket();\n    let obj = {};\n    obj.noncestr = uuid.replace(/-/g, '');\n    obj.timestamp = Math.floor((new Date()).getTime() / 1000);\n    obj.appid = config.wechat.appid;\n    obj.url = url;\n    let str = util.format(\"jsapi_ticket=%s&noncestr=%s&timestamp=%d&url=%s\", ticket, obj.noncestr, obj.timestamp, obj.url);\n    obj.signature = SHA1(str);\n    return obj;\n}\nexports.get_jsapi_signature = get_jsapi_signature;\n\n/**\n * \u670d\u52a1\u56de\u8c03\u9a8c\u8bc1\n * @param params\n * @returns {string}\n */\nexports.service_callback = function (params) {\n    let echostr = params.echostr;\n    let signature = params.signature;\n    let array = [params.nonce, params.timestamp, config.wechat.token];\n    let sign = SHA1(array.sort().join(''));\n    return sign == signature ? echostr : \"Invalid Request\";\n};\n")))}p.isMDXComponent=!0}}]);
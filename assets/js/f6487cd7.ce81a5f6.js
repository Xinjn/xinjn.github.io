"use strict";(self.webpackChunkwiki=self.webpackChunkwiki||[]).push([[85646],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>d});var r=t(67294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var l=r.createContext({}),p=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},c=function(e){var n=p(e.components);return r.createElement(l.Provider,{value:n},e.children)},m={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},u=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(t),d=o,h=u["".concat(l,".").concat(d)]||u[d]||m[d]||a;return t?r.createElement(h,i(i({ref:n},c),{},{components:t})):r.createElement(h,i({ref:n},c))}));function d(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=t.length,i=new Array(a);i[0]=u;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var p=2;p<a;p++)i[p]=t[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},12475:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>m,frontMatter:()=>a,metadata:()=>s,toc:()=>p});var r=t(87462),o=(t(67294),t(3905));const a={},i=void 0,s={unversionedId:"\u524d\u7aef\u57fa\u7840/DEMO/\u56fe\u7247\u4e0a\u4f20/\u5c0f\u7a0b\u5e8f\u7248",id:"\u524d\u7aef\u57fa\u7840/DEMO/\u56fe\u7247\u4e0a\u4f20/\u5c0f\u7a0b\u5e8f\u7248",title:"\u5c0f\u7a0b\u5e8f\u7248",description:"\u53c2\u8003\u9879\u76ee\uff1a\u51e4\u5a31\u6307\u6570/\u51e4\u5411\u6807",source:"@site/docs/\u524d\u7aef\u57fa\u7840/DEMO/\u56fe\u7247\u4e0a\u4f20/\u5c0f\u7a0b\u5e8f\u7248.md",sourceDirName:"\u524d\u7aef\u57fa\u7840/DEMO/\u56fe\u7247\u4e0a\u4f20",slug:"/\u524d\u7aef\u57fa\u7840/DEMO/\u56fe\u7247\u4e0a\u4f20/\u5c0f\u7a0b\u5e8f\u7248",permalink:"/docs/\u524d\u7aef\u57fa\u7840/DEMO/\u56fe\u7247\u4e0a\u4f20/\u5c0f\u7a0b\u5e8f\u7248",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/\u524d\u7aef\u57fa\u7840/DEMO/\u56fe\u7247\u4e0a\u4f20/\u5c0f\u7a0b\u5e8f\u7248.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"H5\u7248",permalink:"/docs/\u524d\u7aef\u57fa\u7840/DEMO/\u56fe\u7247\u4e0a\u4f20/H5\u7248"},next:{title:"\u65e0\u6cd5\u54cd\u5e94 ended \u4e8b\u4ef6",permalink:"/docs/\u524d\u7aef\u57fa\u7840/HTML/Audio\u6807\u7b7e/FAQ/\u65e0\u6cd5\u54cd\u5e94ended\u4e8b\u4ef6"}},l={},p=[],c={toc:p};function m(e){let{components:n,...t}=e;return(0,o.kt)("wrapper",(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"\u53c2\u8003\u9879\u76ee\uff1a\u51e4\u5a31\u6307\u6570/\u51e4\u5411\u6807"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"fileUpload")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'import UploadWx from "@components/uploadWx";\nimport FileUpload from "./uploadComponent";\n\n// \u9ad8\u9636\u7ec4\u4ef6\nexport default UploadWx(FileUpload);\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"uploadComponent")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import React, { Component } from 'react'\nimport { View } from '@tarojs/components'\nimport Taro from '@tarojs/taro'\n\n/*\n  album:\u4ece\u76f8\u518c\u9009\u56fe\n  camera:\u4f7f\u7528\u76f8\u673a\n  user:\u4f7f\u7528\u524d\u7f6e\u6444\u50cf\u5934(\u4ec5H5\u7eaf\u6d4f\u89c8\u5668\u4f7f\u7528)\n  environment:\u4f7f\u7528\u540e\u7f6e\u6444\u50cf\u5934(\u4ec5H5\u7eaf\u6d4f\u89c8\u5668)\n*/\n\n// UA\nconst userAgent = navigator.userAgent.toLocaleLowerCase()\n\n// \u5224\u65ad\u5c0f\u7a0b\u5e8f\u73af\u5883\nexport const isWeapp = () => {\n  const env = Taro.getEnv().toLocaleLowerCase()\n  if (env === 'weapp') {\n    return true\n  } else {\n    return false\n  }\n}\n\n// \u5916\u90e8\u53c2\u6570\u7c7b\u578b\uff08\u5916\u90e8props\u548c\u9ad8\u9636\u51fd\u6570\uff09\ninterface IProps {\n  getUploadHandle: (slides: Array<Object>) => void\n  deleteServerImage: (index: Number) => void\n  deleteServerVideo: (index: Number) => void\n  choose: (type: Array<Object>, img?: Boolean) => void // \u9009\u62e9\u76f8\u518c\u56fe\u7247\n  deleteImg: (index: Number, type: Number) => void // \u5220\u9664\u56fe\u7247\n  imgPath: Array<Object>\n  VideoPath: Array<Object>\n  uploadImgPathArray: Array<Object>\n  changeState?: () => void\n  events?: any\n  secretImgPath: Array<Object>\n  secretVideoPath: Array<Object>\n  isStarUpload: Boolean\n  saveData?: any\n}\n\ninterface PageState {\n  secretImgPath: Array<Object>\n  isAndriodUCbrowser: Boolean\n  imgKeyPath: Array<Object>\n}\n\nclass FileUpload extends Component<IProps, PageState> {\n  state = {\n    secretImgPath: [],\n    imgKeyPath: [],\n    isAndriodUCbrowser:\n      (userAgent.match(/ucbrowser/) || userAgent.match(/ u;/)) &&\n      userAgent.includes('android') &&\n      !userAgent.match(/miuibrowser/) &&\n      !userAgent.match(/vivobrowser/) &&\n      !userAgent.match(/oppo/) &&\n      !userAgent.match(/mqqbrowser/) &&\n      !userAgent.match(/heytapbrowser/),\n  }\n\n  uploadTimer = null\n\n  static getDerivedStateFromProps(nextProps, prevState) {\n    if (nextProps.secretImgPath !== prevState.secretImgPath) {\n      return {\n        isOpenFileUpFixed: prevState.isOpenFileUpFixed,\n        secretImgPath: nextProps.secretImgPath,\n        secretVideoPath: nextProps.secretVideoPath,\n      }\n    }\n    return null\n  }\n\n  componentDidMount() {\n    // \u9ad8\u9636\u51fd\u6570\n    const {\n      getUploadHandle,\n      events // \u9ad8\u9636\u4e8b\u4ef6\u76d1\u542c\n    } = this.props\n\n    // \u4e8b\u4ef6\u76d1\u542c\uff1a\u56fe\u7247\u8fc7\u5927\n    events.on('hasMaxFile', () => {\n      Taro.showToast({\n        title: '\u60a8\u4e0a\u4f20\u7684\u56fe\u7247\u8d85\u8fc75M\u6216\u8005\u89c6\u9891\u8d85\u8fc7100M',\n        icon: 'none',\n        duration: 2000,\n      })\n    })\n    // \u4e8b\u4ef6\u76d1\u542c\uff1a\u4e0a\u4f20\u4e2d\uff08\u65f6\u95f4\u8fc7\u957f\u81ea\u52a8\u65ad\u5f00\uff09\n    events.on('starUpload', () => {\n      Taro.showLoading({\n        title: '\u4e0a\u4f20\u4e2d',\n        mask: true,\n      })\n\n      clearTimeout(this.uploadTimer)\n      this.uploadTimer = setTimeout(() => {\n        Taro.hideLoading()\n        Taro.showToast({\n          title: '\u4e0a\u4f20\u5df2\u8d85\u65f6\uff0c\u8bf7\u91cd\u65b0\u4e0a\u4f20',\n          icon: 'none',\n          duration: 1000,\n        })\n      }, 3000)\n    })\n\n    // \u4e8b\u4ef6\u76d1\u542c\uff1a\u4e0a\u4f20\u7ed3\u675f\n    events.on('endUpload', () => {\n      clearTimeout(this.uploadTimer)\n      Taro.hideLoading()\n    })\n\n    // \u4e8b\u4ef6\u76d1\u542c\uff1a\u83b7\u53d6\u672c\u5730\u5316\u6570\u636e\n    events.on(\n      'uploadFinish',\n      (uploadImgPathArray, failArray) => {\n\n        if (failArray && failArray.length > 0) {\n          Taro.showToast({\n            title: '\u60a8\u4e0a\u4f20\u7684\u6587\u4ef6\u5931\u8d25\uff0c\u8bf7\u91cd\u65b0\u4e0a\u4f20\uff01',\n            icon: 'none',\n            duration: 1000,\n          })\n        }\n        // \u4ec5\u83b7\u53d6\u6700\u65b0\u4e00\u5f20\n        const newUploadImgPathArray = uploadImgPathArray.slice(-1)\n        console.log('uploadImgPathArray', newUploadImgPathArray);\n\n        // \u56fe\u7247URL[]\n        const imgKeyPath = []\n\n        newUploadImgPathArray.map(item => {\n          const imgKey =\n            (item &&\n              item.split('/') &&\n              item.split('/').pop() &&\n              item.split('/').pop().split('.')[0]) ||\n            ''\n\n          if (imgKey) {\n            imgKeyPath.push(imgKey)\n          }\n        })\n\n        this.setState({\n          imgKeyPath,\n        })\n\n        getUploadHandle(newUploadImgPathArray)\n      }\n    )\n  }\n\n  changeShowStatus = () => {\n    const { isOpenFileUpFixed } = this.state\n\n    this.setState({ isOpenFileUpFixed: !isOpenFileUpFixed })\n  }\n\n  // \u4e0a\u4f20\u56fe\u7247:\u8c03\u7528\u9ad8\u9636\u51fd\u6570\n  fileUploadType = async (type) => {\n    // \u7c7b\u578b\u4e3a\u56fe\u7247\u96c6\u5408\n    if (type === 'slides') {\n      if (isWeapp()) {\n        // \u5c0f\u7a0b\u5e8f\n        this.props.choose(['album', 'camera'], 1, 5242880)\n      } else {\n        // \u7aef\u5916\n        this.props.choose(['album'], 1, 5242880)\n      }\n    }\n  }\n\n  render() {\n    return (\n      <View\n        className={styles.attachmentButton}\n        onClick={this.fileUploadType.bind(this, 'slides')}\n      />\n    )\n  }\n}\n\nexport default FileUpload\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"UploadWx")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import Core from '@ifeng/taro_upload_core'\nimport React, { Component } from 'react'\nimport Taro, { Events } from '@tarojs/taro'\nimport { View } from '@tarojs/components'\n// \u624b\u5199Promise.allSettled:\u6355\u83b7\u5168\u90e8\u72b6\u6001\nimport { all_settled } from '@utils/utils/util'\n\n// \u7528\u6237token\nlet  token = Taro.getStorageSync('token')\n\ninterface sourceType {\n  /** \u4ece\u76f8\u518c\u9009\u56fe */\n  album\n  /** \u4f7f\u7528\u76f8\u673a */\n  camera\n  /** \u4f7f\u7528\u524d\u7f6e\u6444\u50cf\u5934(\u4ec5H5\u7eaf\u6d4f\u89c8\u5668\u4f7f\u7528) */\n  user\n  /** \u4f7f\u7528\u540e\u7f6e\u6444\u50cf\u5934(\u4ec5H5\u7eaf\u6d4f\u89c8\u5668) */\n  environment\n}\n\nconst UploadWx = WrappedComponent => {\n  return class T extends Component {\n    state = {\n      imgPath: [],\n      uploadImgPathArray: [], // \u4e0a\u4f20\u56fe\u7247\u96c6\u5408\n      processArray: [],\n    }\n    //\n    events = new Events()\n    uploadCore = null\n\n    // \u521d\u59cb\u670d\u52a1\u5668\uff08\u817e\u8baf\u6876\uff09\n    componentDidMount() {\n      this.uploadCore = new Core({\n        appid: 'ifeng-wind-vane', // \u51e4\u5a31\u6307\u6570\uff1a\u817e\u8baf\u6876\n        token: token,\n        apiUrl: 'https://skserver.ifeng.com/cos/getCredential',\n        initFail: function (err: any) {\n          console.error('error', err)\n          throw new Error(err)\n        },\n      })\n    }\n    // \u9009\u62e9\u56fe\u7247\n    choose = async (\n      type: Array<keyof sourceType>,\n      count?: number,\n      size?: number\n    ) => {\n        try {\n          // Taro\u4e0a\u4f20\u56fe\u7247\n          let res = await Taro.chooseImage({\n            count: count || 9, // \u6700\u591a\u53ef\u4ee5\u9009\u62e9\u7684\u56fe\u7247\u5f20\u6570\n            sourceType: [...type],\n          })\n\n          const { tempFiles, tempFilePaths = [] } = res\n          console.log('tempFiles',tempFiles);\n\n          // \u4f53\u79ef\u9650\u5236\n          if (size) {\n            if (this.isHasMaxFile(tempFiles, size)) {\n              return false\n            }\n          }\n\n          this.uploadAll( tempFiles, tempFilePaths)\n        } catch (error) {\n          console.log(error)\n        }\n    }\n    // \u9650\u5236\u4e0a\u4f20\u6587\u4ef6\u5927\u5c0f\n    isHasMaxFile = (tempFiles, limitSize) => {\n      if (!tempFiles) return false\n      for (let i = 0, len = tempFiles.length; i < len; i++) {\n        const iItem = (tempFiles[i] && tempFiles[i].size) || 0\n        const maxFileSize = limitSize || 104857600\n        if (iItem > maxFileSize) {\n          this.events.trigger('hasMaxFile')\n          return true\n        }\n      }\n\n      return false\n    }\n    // \u56fe\u7247\u4e0a\u4f20\u670d\u52a1\n    uploadAll = async (tempFiles, tempFilePaths) => {\n\n      try {\n        // \u5f00\u59cb\u4e0a\u4f20\u4e8b\u4ef6\n        this.events.trigger('starUpload')\n        const promiseArr = tempFiles.map(item => {\n          console.log(item.size)\n          return new Promise((resolve, reject) => {\n            try {\n              if (item.size > 10 * 1024 * 1024) {\n                this.uploadCore.uploadBigFile({\n                  file: {\n                    filePath: item.path,\n                    size: item.size,\n                  },\n                  success: function (res) {\n                    resolve(res?.sourcePath)\n                  },\n                  error: function (err) {\n                    console.error('\u4e0a\u4f20\u51fa\u9519\u5566', err)\n                    reject(0)\n                  },\n                })\n              } else {\n                console.log('\u5f00\u59cb\u4e0a\u4f20\u4e8b\u4ef6');\n                this.uploadCore.uploadFile({\n                  file: {\n                    filePath: item.path,\n                    size: item.size,\n                  },\n                  success: function (res) {\n                    resolve(res.sourcePath)\n                  },\n                  error: function (err) {\n                    console.error('\u4e0a\u4f20\u51fa\u9519\u5566', err)\n                    reject(0)\n                  },\n                })\n              }\n            } catch (error) {\n              console.log(error)\n              reject(0)\n            }\n          })\n        })\n\n        // \u83b7\u53d6\u6240\u6709\u56fe\u7247\u4e0a\u4f20\u72b6\u6001\n        const resArr = await all_settled(promiseArr)\n        // \u6210\u529f\n        const uploadSucess = []\n        // \u5931\u8d25\n        const uploadError = []\n\n        resArr.forEach((item, index) => {\n          const { value } = item\n          if (value) {\n            uploadSucess.push(tempFilePaths[index])\n          } else {\n            uploadError.push(tempFilePaths[index])\n          }\n        })\n\n        // \u670d\u52a1\u5668\u56fe\u7247\u5730\u5740\n        let uploadUrlSucessImg = this.state.uploadImgPathArray\n        // \u672c\u5730\u56fe\u7247\u5730\u5740\n        let imgPath = this.state.imgPath\n\n          uploadUrlSucessImg = uploadUrlSucessImg.concat(\n            resArr.filter(item => item.value).map(item => item.value)\n          )\n          imgPath = imgPath.concat(uploadSucess)\n\n        this.setState({\n          imgPath,\n          uploadImgPathArray: uploadUrlSucessImg,\n        })\n\n        // \u4e8b\u4ef6\u89e6\u53d1\uff1a\u5b8c\u6210\u4e0a\u4f20\u4f20\u9012\u53c2\u6570\n        this.events.trigger(\n          'uploadFinish',\n          uploadUrlSucessImg,\n          uploadError\n        )\n        this.events.trigger('endUpload')\n      } catch (error) {\n        console.log(error)\n      }\n    }\n    deleteImg = (index, type = 1) => {\n      // 1 \u56fe\u7247, 2 \u89c6\u9891\n      if (type === 1) {\n        // \u5220\u9664\u6307\u5b9a\u56fe\u7247\n        let imgPath = this.state.imgPath\n        let uploadImgPathArray = this.state.uploadImgPathArray\n        imgPath.splice(index, 1)\n        uploadImgPathArray.splice(index, 1)\n        this.setState({\n          imgPath,\n          uploadImgPathArray,\n        })\n      }\n    }\n    render() {\n      let {\n        uploadImgPathArray,\n        imgPath,\n        processArray,\n      } = this.state\n      return (\n        <View>\n          <WrappedComponent\n            choose={this.choose}\n            imgPath={imgPath}\n            uploadImgPathArray={uploadImgPathArray}\n            deleteImg={this.deleteImg}\n            processArray={processArray}\n            events={this.events}\n            {...this.props}\n          />\n        </View>\n      )\n    }\n  }\n}\n\nexport default UploadWx\n")))}m.isMDXComponent=!0}}]);